# React開発で、オブジェクトの型を、どう定義するのが効率的なのかを調べる

ReactをTypeScriptで開発したい、と思ったときに、型を、どうやって定義したら良いのか意外と自明ではなかったので
調べてみた。

## 問題意識

### 例

例えば、以下のようなER図で表されるClientとDealというエンティティのCRUDアプリを考えてみる。

``` mermaid
erDiagram
  Client ||--o{ Deal : contains
  Client {
    int id
    string name
  }
  Deal {
    int id
    string name
    int clientId
  }
```

すごいシンプルに

``` typescript
type Client = {
    id: number,
    name: string
};
type Deal = {
    id: number,
    name: string,
    clientId: number
}
```

というような型を、まずは定義することになる。
しかし、実際にCRUDの機能を考えると、型はこれだけでは全く足らないことが分かる。

### 新規作成時の問題

例えば、Dealの新規作成を考える。Dealを作成するにはnameとclientIdが必要なので、それぞれを入力するための
何かしらの入力要素が用意される。Reactでは、`useState`を使って、これら入力要素の内容をstateと同期することが
一般的である。

このstateの型をどうすれば良いか。DBのスキーマから自然に導かれる型においては、
Dealの全てのプロパティはnot nullである。
一方で、今、まさに定義しようとしているDealオブジェクトには、まだ、名前が記入されてないかもしれない。
そもそも、idはDBで自動発番したいので、フロント側で情報を入力している間には決まりようがない 🙃

### 一覧時の問題

Clientの一覧画面を考えてみる。Clientには、0個以上複数のDealが紐付いているので、こいつらも一緒に表示したいとしよう。
個々のClientごとに、対応するDealを問い合わせるのはN+1問題なので、API側に、Dealも含めてClientの一覧を返すような
エンドポイントを用意することになるだろう。この返り値の型は、どうすべきだろうか。
上のClient型の定義には、`deals: Deal[]`のようなプロパティはない 🤔

### 問題意識のまとめ

上のような状況に対応するためには、基本となる型(ClientやDeal)をもとにして、一部のプロパティをOptionalにしたり、新しいプロパティを追加したりできるようにしたい。TypeScriptには、Omit、Pick、Partialなどなど、そういったニーズに
対応する型を操作して別の型を作る機能がある。
Reactで、典型的なアプリを作る場合に、これらをどう組み合わせるのが効果的なのかを調べた・・というのがこのレポジトリの
意図である。

## 実装してみて

### その1

まずは、Clientの一覧(配下のDealも含む)画面だけ作ってみて思ったことをまとめる。

各々の場面に合わせた型を作ることは可能、頑張れば: 一部を削ったり、付け加えたり・・という道具があるので、頑張って組み合わせれば原理的にはできるだろう。

場面ごとに、完璧にニーズに合った型を定義するのは現実的ではなさそう: 現時点で作ったClientの一覧画面では、DealのclientIdプロパティは不要である。なので、この画面で必要な、冗長な情報を省いた必要にして十分な型というのは、「DealからclientIdだけ除いた型の配列dealsをClientに加えた型の配列」という感じになる。上に述べたとおり、こういう型を定義することはできるだろう。しかし、アプリの機能を増やしていくと、必要十分な型というのが微妙に異なる場面というのが無限に増えていくことが想像される。それぞれに対してピッタリとニーズに合った型を定義するのは、労力に見合わないと思った。

ということは、アプリに必要とされる機能をよくよく考えて選んで、慎重に必要な型を検討し、冗長性と管理の手間とのトレードオフの中で、現実的な落とし所を探す必要がある、ということなのだろう。

そもそも、ClientやDealの中身のプロパティの要不要を場面ごと・機能ごとに細かく調整するのが、あまり良くなさそう。型の定義は型の定義として、独立に考えることとし、その他の部分では、型の中身に関する特別な知識をなるべく排してコーディングできる方がDXはよさそう。
